Listen 80
Listen 443

<VirtualHost *:80>
    ServerName serveurentreamis.ddns.net
    ServerAlias www.serveurentreamis.ddns.net
    Redirect permanent / https://serveurentreamis.ddns.net/
</VirtualHost>

<VirtualHost *:443>
    ServerName serveurentreamis.ddns.net
    ServerAlias www.serveurentreamis.ddns.net
    DocumentRoot /var/www/html/serveurwebyanis

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/serveurentreamis.ddns.net/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/serveurentreamis.ddns.net/privkey.pem

    # Activer les modules proxy
    ProxyRequests Off
    ProxyPreserveHost On

    # Configuration des en-têtes
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    
    # Configuration Content Security Policy
    Header always set Content-Security-Policy "default-src 'self' https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self'"

    # Autoriser l'accès au proxy
    <Proxy *>
        Require all granted
    </Proxy>

    # Servir les fichiers statiques directement depuis Apache
    <LocationMatch "^/(?:css|js|videos)/.*$">
        ProxyPass !
    </LocationMatch>

    # Redirection vers Node.js
    ProxyPass / http://127.0.0.1:3000/
    ProxyPassReverse / http://127.0.0.1:3000/

    # Configuration CORS
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "POST, GET, OPTIONS, DELETE, PUT"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization"

    # Logs
    LogLevel debug
    ErrorLog ${APACHE_LOG_DIR}/serveurentreamis_error.log
    CustomLog ${APACHE_LOG_DIR}/serveurentreamis_access.log combined
</VirtualHost>
